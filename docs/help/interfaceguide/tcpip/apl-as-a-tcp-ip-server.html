<!doctype html>
<html>
<head><meta charset="utf-8"><title></title><link rel="stylesheet" href="../../../help.css"></head>
<body><h2><a name="TCPIP_Server"></a>APL as a TCP/IP Server</h2><p>A Stream based APL server initiates a connection by creating a TCPSocket object whose SocketType is <tt>'Stream'</tt> (the default).</p><p>The service is uniquely identified on the network by the server’s IP Address and port number which are specified by the LocalAddr and LocalPort properties respectively. Note that unless you have more than one network adapter in your computer, LocalAddr is normally allowed to default.</p><p>This TCPSocket object effectively defines the availability of a particular service and at this stage is known as a <span class="Italic">listening socket</span> which is simply waiting for a client to connect. This is reflected by the value of its CurrentState property which is <tt>'Listening'</tt>.</p><p>For example:</p><pre>      'S0'⎕WC'TCPSocket' ('LocalPort' 2001)
      'S0'⎕WG'CurrentState'
 Listening</pre><p>When a client connects to the APL server, the state of the TCPSocket object (which is reported by the CurrentState property) changes from <tt>'Listening'</tt> to <tt>'Connected'</tt> and it generates a TCPAccept event. Note that the connection cannot be nullified by the return value of a callback function attached to this event. </p><p>At this point, you can identify the client by the value of the RemoteAddr property of the TCPSocket object. If you wish to reject a particular client, you must immediately expunge the (connected) TCPSocket and then create a new one ready for another client.</p><h4><a name="Multiple_Clients"></a>Serving Multiple Clients</h4><p>Dyalog APL provides a special mechanism to enable a single server to connect to multiple clients. This mechanism is designed to accommodate the underlying operation of the Windows socket interface in the most convenient manner for the APL programmer.</p><p>What actually happens when a client connects to your server, is that Windows automatically creates a new socket, leaving the original server socket intact, and still listening. At this stage, APL has a single name (the name of your TCPSocket object) but two sockets to deal with.</p><p>As it would be inappropriate for APL itself to assign a new name to the new socket, it disassociates the TCPSocket object from its original socket handle, and re-associates it with the new socket handle. This is reflected by a corresponding change in its SocketNumber property.  The original listening socket is left, temporarily, in a state where it is not associated with the name of any APL object.</p><p>Having performed these operations, APL checks to see if you have attached a callback function to the TCPAccept event. If not, APL simply closes the original listening socket. This then satisfies the simple case where the server is intended to connect with only a single client and your socket has simply changed its state from <tt>'Listening'</tt> to <tt>'Connected'</tt>.</p><p>If there <span class="Italic">is</span> a callback function attached to the TCPAccept event, APL invokes it and passes it the window handle of the listening socket. What the callback must do is to create a new TCPSocket object associated with this handle. If the callback exits without doing this, APL closes the original listening socket thereby preventing further clients from connecting.</p><p>If you wish to serve multiple clients, you must continually allocate new TCPSocket objects to the listening socket in this way so that there is always one available for connection. </p><p>The following example illustrates how this is done. Note that when the callback creates the new TCPSocket object, you <b>must not</b> specify any other property except SocketNumber, Event and Data in the <tt>⎕WC</tt> statement that you use to create it. This is important as the objective is to associate your new TCPSocket object with the original listening socket whose IP address and port number must remain unaltered.</p><h4>Example</h4><p>The original listening socket is created with the name <tt>S0</tt> and with a callback function <tt>ACCEPT</tt> attached to the TCPAccept event. The <tt>COUNT</tt> variable is initialised to <tt>0</tt>. This variable will be incremented and used to generate new names for new TCPSocket objects as each client connects.</p><pre>     COUNT←0
     'S0'⎕WC'TCPSocket' ('LocalPort' 2001)
                        ('Event' 'TCPAccept' 'ACCEPT')</pre><p>Then, each time a client connects, the <tt>ACCEPT</tt> function clones the original listening socket with a sequence of new TCPSocket objects using the name <tt>S1</tt>, <tt>S2</tt>, and so forth.</p><pre>     ∇ ACCEPT MSG
[1]    COUNT+←1
[2]    ('S',⍕COUNT)⎕WC 'TCPSocket'('SocketNumber'(3⊃MSG))
     ∇</pre></body>
</html>