<!doctype html>
<html>
<head><meta charset="utf-8"><title></title><link rel="stylesheet" href="../../../help.css"></head>
<body><h2><a name="CFILES_Workspace"></a>The CFILES Workspace</h2><p><tt>CFILES.DWS</tt> contains a single OLEServer namespace called <tt>CFiles</tt> which implements a basic object-oriented interface to Dyalog APL component files.</p><p>This example allows an OLE Client, such as Excel, to read and write APL component files. It is deliberately over-simplified but illustrates how an object hierarchy may be implemented.</p><p>Unlike the previous example, the CFILES workspace is supplied as a complete OLEServer with all of the COM properties for its methods already defined. All you have to do is to export it as a COM Server.</p><p>The <tt>CFiles</tt> namespace contains a single function <tt>OpenFile</tt> and a sub-namespace called <tt>File</tt> which is also an OLEServer. This namespace contains functions <tt>FREAD</tt>, <tt>FREPLACE</tt>, <tt>FAPPEND</tt> and <tt>FSIZE</tt>.</p><p>To use this Server, an OLE Client requests an instance of the <tt>dyalog.CFiles</tt> object.</p><p>To open a component file, an OLE Client calls OpenFile with the name of the file as its argument. This function opens the file and returns, not a file tie number as you might expect, but an instance of the File namespace which is associated with the file. As far as the client is concerned, this is a subsidiary OLE object of type <tt>dyalog.File</tt>.</p><p>To perform file operations, the client invokes the <tt>FREAD</tt>, <tt>FREPLACE</tt>, <tt>FAPPEND</tt> and <tt>FSIZE</tt> methods (functions) of the File object.</p><p>A more sophisticated example might expose each component as a subsidiary object too.</p><h4><a name="Registering_CFILES"></a>Registering CFiles as an OLE Server</h4><p>In order to explore the use of an APL OLE Server using the CFILES workspace as an example, you must register the CFiles object on your system.</p><p><tt>)LOAD</tt> the <tt>CFILES</tt> workspace from the <span class="Code">samples\ole</span> sub-directory</p><pre>      )LOAD SAMPLES\OLE\CFILES
samples\ole\cfiles saved ...
      )OBS
CFiles</pre><p>Then select <span class="Italic">Export</span> from the Session <span class="Italic">File</span> menu and create either an in-process or out-of process OLE Server.</p><h4><a name="OpenFile"></a>The OpenFile Function</h4><pre>     ∇ FILE←OpenFile NAME;F;TIE
[1]   ⍝ Makes a new File object
[2]    TIE←1+⌈/0,⎕FNUMS
[3]    NAME ⎕FTIE TIE
[4]    File.TieNumber←TIE
[5]    File.Name←NAME
[6]    FILE←⎕OR'File'
     ∇</pre><p><tt>OpenFile</tt> takes the name of an existing component file and opens it exclusively using <tt>⎕FTIE</tt>.</p><p>It returns an instance of the <tt>File</tt> namespace that is associated with the file through the variable <tt>TieNumber</tt>. This is global to the <tt>File</tt> namespace.</p><p><tt>OpenFile[4]</tt>sets the variable <tt>TieNumber</tt> in the <tt>File</tt> namespace to the tie number of the requested file.</p><p><tt>OpenFile[5]</tt>sets the variable <tt>Name</tt> in the <tt>File</tt> namespace to the name of the requested file. This is not actually used.</p><p><tt>OpenFile[6]</tt>creates an instance of the <tt>File</tt> namespace using <tt>⎕OR</tt> and returns it as the result.</p><p>Note that there is a separate instance of <tt>File</tt> for every file opened by every OLE Client that is connected. Each knows its own <tt>TieNumber</tt> and <tt>Name</tt>.</p><p>The COM Properties dialog box for <tt>OpenFile</tt> is shown below. The function is declared to take a single parameter called <span class="Italic">FileName</span> whose data type is VT_BSTR (a string). The result of the function is of data type VT_DISPATCH. This data type is used to represent an object.</p><p><img src="../images/cfiles-openfile-props.png" /></p><h4><a name="FSIZE"></a>The FSIZE Function</h4><pre>     ∇ R←FSIZE
[1]    R←⎕FSIZE TieNumber
     ∇</pre><p><tt>FSIZE</tt> returns the result of  <tt>⎕FSIZE</tt> for the file associated with the current instance of the File namespace. </p><p>The COM Properties dialog box for <tt>FSIZE</tt> is shown below. The function is declared to take no parameters. The result of the function is of data type VT_VARIANT. This data type is used to represent an arbitrary APL array.</p><p><img src="../images/cfiles-fsize-props.png" /></p><h4><a name="FREAD"></a>The FREAD Function</h4><pre>     ∇ R←FREAD N
[1]    R←⎕FREAD TieNumber,N
     ∇</pre><p><tt>FREAD</tt> returns the value in the specified component read from the file associated with the current instance of the File namespace. </p><p>The COM Properties dialog box for <tt>FREAD</tt> is shown below. The function is declared to take a single parameter called <span class="Italic">Component</span> whose data type is VT_I4 (an integer). The result of the function is of data type VT_VARIANT. This data type is used to represent an arbitrary APL array.</p><p><img src="../images/cfiles-fread-props.png" /></p><h4><a name="FAPPEND"></a>The FAPPEND Function</h4><pre>     ∇ R←FAPPEND DATA
[1]    R←DATA ⎕FAPPEND TieNumber
     ∇</pre><p><tt>FAPPEND</tt> appends a component onto of the file associated with the current instance of the File namespace. </p><p>The COM Properties dialog box for <tt>FAPPEND</tt> is shown below. The function is declared to take a single parameter called <span class="Italic">Data</span> whose data type is VT_VARIANT. This data type is used to represent an arbitrary APL array. The result of the function is of data type VT_I4 (an integer).</p><p><img src="../images/cfiles-fappend-props.png" /></p><h4><a name="FREPLACE"></a>The FREPLACE Function</h4><pre>     ∇ FREPLACE ID;I;DATA
[1]    I DATA←ID
[2]    DATA ⎕FREPLACE TieNumber,I
     ∇</pre><p><tt>FREPLACE</tt> replaces the specified component of the file associated with the current instance of the File namespace. </p><p>The COM Properties dialog box for <tt>FREPLACE</tt> is shown below. The function is declared to take two parameter. The first is called <span class="Italic">Component</span> and is of data type VT_I4 (integer). The second parameter is  called <span class="Italic">Data</span> and is of data type VT_VARIANT. This data type is used to represent an arbitrary APL array. The result of the function is of data type VT_VOID, which means that the function does  not return a result.</p><p><img src="../images/cfiles-freplace-props.png" /></p><h4><a name="CFiles_Excel"></a>Using CFiles from Excel</h4><p>Start Excel and load the spreadsheet CFiles.xls from the Dyalog APL sub-directory <span class="Code">samples\ole</span>.</p><p>Please note that to simplify the Excel code, only components containing matrices (such as those contained in samples\ole\test.dcf) are handled. Components containing scalars, vectors, higher-rank arrays and complex nested arrays are not supported.</p><p><img src="../images/cfiles-excel-example.png" /></p><p>To open a file, type the name of the file and click the <span class="Italic">Open</span> button. This runs the FOpen procedure. A test file named <span class="Code">test.dcf </span>is provided in the <span class="Code">samples\ole</span> sub-directory.</p><p>To read a component, enter the component number and click <span class="Italic">Read</span>. This runs the FRead procedure.</p><p>To replace a component, first enter the component number. Then type some data elsewhere on the spreadsheet and select it. Now click <span class="Italic">Replace</span>. This runs the FReplace procedure.</p><p>To append a component, enter some data elsewhere on the spreadsheet and select it. Now click <span class="Italic">Append</span>. This runs the FAppend procedure.</p><h4>The FOpen Procedure</h4><pre class="Code">Public CF As Object
Public File As Object
 
Dim Data As Variant
 
Sub FOpen()
    Set CF = CreateObject("dyalog.CFILES")
    f = Cells(1, 2).Value
    Set File = CF.OpenFile(f)
    Call FSize
End Sub</pre><p>In the declaration section, the first statement declares a global variable CF to be of data type Object. This variable will be connected to the dyalog.CFiles OLE Server object. The second statement declares a global variable File to be of data type Object. This variable will be connected to the dyalog.File OLE Server object. The third statement declares a global variable Data to be of data type Variant. This is equivalent to a nested array. This variable will be used for the component data.</p><p>The statement:</p><pre class="Code">Set CF = CreateObject("dyalog.CFILES")</pre><p>causes OLE to start Dyalog APL and obtain an instance of the dyalog.CFiles OLE Server object which is then associated with the variable CF. Because this variable is global, the OLE Server remains in memory and available for use.</p><p>The statement</p><pre class="Code">f = Cells(1, 2).Value</pre><p>gets the name of the file to be opened and puts it into the (local) variable f.</p><p>Finally, the statement:</p><pre class="Code">Set File = CF.OpenFile(f)</pre><p>calls the OpenFile function and stores the result (which is an object) in the global variable File.</p><h4>The FRead Procedure</h4><pre class="Code">Sub FRead()
    c = Cells(4, 2).Value
    Data = File.FREAD(c)
    For r = 0 To UBound(Data, 1)
        For c = 0 To UBound(Data, 2)
            Cells(r + 6, c + 2).Value = Data(r, c)
        Next c
    Next r
End Sub </pre><p>The statement:</p><pre class="Code">c = Cells(4, 2).Value</pre><p>gets the number of the component to be read and stores it in the (local) variable c.</p><p>The statement:</p><pre class="Code">Data = File.FREAD(c)</pre><p>calls the <tt>FREAD</tt> function in the instance of the <tt>File</tt> namespace that is connected to the (global) Excel variable File. The result is stored in the variable Data. </p><p>The remaining statements copy the data from Data into the spreadsheet.</p><h4>The FReplace Procedure</h4><pre class="Code">Sub FReplace()
    c = Cells(4, 2).Value
    Data = Selection.Value
    Call File.FReplace(c, Data)
    Call Fsize()
End Sub</pre><p>The statement:</p><pre class="Code">c = Cells(4, 2).Value</pre><p>gets the number of the component to be replaced and stores it in the (local) variable c.</p><p>The statement:</p><pre class="Code">Data = Selection.Value</pre><p>gets the contents of the selected range of cells and stores it in the variable Data. This will be a 2-dimensional matrix. </p><p>The statement:</p><pre class="Code">Call File.FReplace(c, Data)</pre><p>calls the <tt>FREPLACE</tt> function in the instance of the <tt>File</tt> namespace that is connected to the (global) Excel variable File.</p><h4>The FAppend Procedure</h4><pre class="Code">Sub FAppend()
    Dim Rslt As Variant
    Data = Selection.Value
    Rslt = File.FAppend(Data)
    Call Fsize()
End Sub</pre><p>The statement:</p><pre class="Code">Data = Selection.Value</pre><p>gets the contents of the selected range of cells and stores it in the variable Data. This will be a 2-dimensional matrix. </p><p>The statement:</p><pre class="Code">Rslt = File.FAppend(Data)</pre><p>calls the <tt>FAPPEND</tt> function in the instance of the <tt>File</tt> namespace that is connected to the (global) Excel variable File. The result of this function is ignored.</p><script src="../../../help.js"></script></body>
</html>