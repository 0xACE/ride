<!doctype html>
<html>
<head><meta charset="utf-8"><title></title><link rel="stylesheet" href="../../../help.css"></head>
<body><h2><a name="Dual_Tutorial"></a>The Dual Control Tutorial</h2><p>The ActiveX control we will use in this example is deliberately an extremely simple one; so that the intricacies of the control itself do not get in the way of the principles involved. In practice, there are actually very few restrictions concerning the complexity of the ActiveX control, and it is perfectly possible to package complete multiple-window Dyalog APL applications in this way.</p><p>Your ActiveX control will be called a <span class="Italic">Dyalog Dual Control</span> and is based on the Dyalog APL TrackBar object.</p><p>The Dual control allows the user to enter a number using a slider, whilst displaying its value in two different units. For example, you could use it to enter a temperature value which is displayed in both Centigrade and Fahrenheit units. Equally, the same control could be used to enter a measurement of length which is concurrently displayed in centimetres and inches.</p><p><img src="../images/dual-overview.png" /></p><h4>Methods</h4><p>None. (The Dual control provides no methods.)</p><h4 class="ExampleNewPage">Properties</h4><p>The Dual control provides the following properties:</p><table><tr><th class="Left">Property</th><th class="Left">Description</th></tr><tr><td>Caption1</td><td>A text string that describes the primary units. This is displayed in the top left corner of the object.</td></tr><tr><td>Caption2</td><td>A text string that describes the secondary or derived units. This is displayed in the bottom left corner of the object.</td></tr><tr><td>Value1</td><td>The current value of the control measured in primary units</td></tr><tr><td>Value2</td><td>The current value of the control measured in secondary units.</td></tr><tr><td>Intercept</td><td>Used to derive Value2 from Value1</td></tr><tr><td>Gradient</td><td>Used to derive Value2 from Value1</td></tr><tr><td>Min</td><td>The minimum value of Value1</td></tr><tr><td>Max</td><td>The maximum value of Value1</td></tr></table><p>Value2 is derived from Value 1 using the expression:</p><pre>      Value2←Intercept+Gradient×Value1</pre><h4>Events</h4><p>Your Dual control will generate a <span class="Italic">ChangeValue1 </span>event whenever the user alters Value1 using the slider.</p><p>The event message will contain a single parameter (the new value) which may be modified by the host application.</p><p>In other words, every time the value in the control changes, the host application may detect this as an event and has the opportunity to override the user.</p><p>Your Dual control will also generate a <span class="Italic">ChangeValue2</span> event whenever the derived value in the control (Value2) changes. This event is reported for information only.</p><h4><a name="Introducing_Dual_Control"></a>Introducing the Dual Control</h4><p>To save time, the basic APL code for the Dual control has already been written. However, you will have to turn it into an ActiveX control yourself.</p><p>Load the DUALBASE workspace:</p><pre>      )LOAD SAMPLES\ACTIVEX\DUALBASE</pre><p>Run the function <tt>TEST</tt> and observe how the 2 Dual controls behave.</p><p>View the function <tt>TEST</tt> and observe how 2 separate instances of the <tt>Dual</tt> namespace <tt>F.D1</tt> and <tt>F.D2</tt> have been created using <tt>⎕OR</tt> and <tt>⎕NS</tt>.</p><p>Using the Dyalog APL Workspace Explorer, open up the various namespaces. See how <tt>F.D1</tt> and <tt>F.D2</tt> are clones of <tt>Dual</tt>.</p><p>Open the function <tt>Dual.Create</tt> and see how the individual components of the control are defined.</p><p>Close the Form <tt>F</tt>.</p><h4><a name="Changing_Dual_ActiveX"></a>Changing Dual into an ActiveX Control</h4><p>Change the name of the workspace to DUAL:</p><pre>      )WSID DUAL</pre><p>Make a new namespace called <tt>F</tt></p><pre>      )NS F</pre><p>Using the Workspace Explorer, move the <tt>Dual</tt> namespace into <tt>F</tt>, so that <tt>Dual</tt> is a child namespace of <tt>F</tt>.</p><p>Now edit the function <tt>F.Dual.Create</tt> and make the following changes:</p><p>Remove all references to the local variable <tt>POSITION</tt>. This change is required because an ActiveX control has no say in its position within its parent. (Hint: use the Search/Replace dialog to remove all occurrences of <tt>POSITION+</tt>)</p><p>Remove the right argument, <tt>SIZE</tt> and change <tt>Create[1]</tt> from:</p><pre>      H W←SIZE</pre><p>to</p><pre>      H W←Size</pre><p>This change allows the control to fit itself within the space allocated by the host application.</p><p>Change <tt>Create[4]</tt> from:</p><pre>      CH←⊃##.GetTextSize 'W'</pre><p>to</p><pre>      CH←⊃GetTextSize 'W'</pre><p>The original code was designed to pick up the character height from the parent Form. The ActiveXControl object does this automatically via its own GetTextSize method.</p><p>After making these changes, the Create function should be as follows:</p><pre>     ∇ Create;H;W;POS;SH;CH;Y1;Y2
[1]    H W←Size
[2]    SH←40 ⍝ Default Trackbar height
[3]    POS←2↑⌊0.5×0⌈(H-SH)
[4]    CH←⊃GetTextSize'W'
[5]    'Slider'⎕WC'TrackBar'(POS)('Size'SH W)
[6]    Slider.(Limits AutoConf)←(Min,Max)0
[7]    Slider.(TickSpacing TickAlign)←10 'Top'
[8]    Slider.onThumbDrag←'ChangeValue'
[9]    Slider.onScroll←'ChangeValue'
[10]   Y1←POS[1]-CH+1
[11]   Y2←POS[1]+SH+1
[12]   'Cap1'⎕WC'Text'Caption1(Y1,0)('AutoConf' 0)
[13]   'Cap2'⎕WC'Text'Caption2(Y2,0)('AutoConf' 0)
[14]   'V1'⎕WC'Text'(⍕Value1)(Y1,W)
                    ('HAlign' 2)('AutoConf' 0)
[15]   CalcValue2
[16]   'V2'⎕WC'Text'(⍕Value2)(Y2,W)
                    ('HAlign' 2)('AutoConf' 0)
     ∇</pre><p>Open the function <tt>F.Dual.Build</tt>. This function turns the Dual’s parent namespace into a Form (an ActiveXControl currently requires a parent Form) and turns Dual itself into an ActiveXControl. It then attaches functions Create and Configure as callbacks on the Create and Configure events of the ActiveXControl object itself.</p><pre>     ∇ Build
[1]    ##.⎕WC'Form'('Coord' 'Pixel')('KeepOnClose' 1)
[2]    ⎕WC'ActiveXControl'('Size' 80 200)
                          ('KeepOnClose' 1)
[3]    ⎕WS'Event' 'Create' 'Create'
[4]    ⎕WS'Event' 'Configure' 'Configure'
[5]    ⎕NQ'' 'Create'
     ∇</pre><p>Run function <tt>F.Dual.Build</tt>. You should see a Form containing a single instance of the Dual control. Please resist any temptation to play with it at this stage; we want it to be in its default state for when we save it.</p><p>Type the following expression; note that the ClassID, which uniquely identifies your control, is allocated when you create the ActiveXControl object.</p><pre>      F.Dual.ClassID</pre><p>Save the workspace (DUAL.DWS).</p><p>From the Session <span class="Name">File</span> menu, select <span class="Name">Export</span>, choose where you want to save your OCX, and then click Save. It is a good idea to clear the <span class="Name">Runtime application</span> checkbox so that you can debug the control if anything goes wrong.</p><p><img src="../images/dual-export.png" /></p><h4><a name="Testing_Dual"></a>Testing the Dual Control</h4><p>This section describes how you can test and exercise the Dual control using Microsoft Visual Basic 2010 Express which is henceforth referred to as VB.</p><p>Close Dyalog APL</p><p>Start VB and create a new Windows Forms Application Project.</p><p>Click the right mouse button in the General section of the Toolbox window and select  <span class="Name">Choose Items ... </span>from the pop-up menu. In the <span class="Name">Choose Toolbox Items</span> dialog box, click the <span class="Name">COM Components</span> tab.</p><p>Locate the control named <span class="Name">Dyalog DUAL Control</span>,enable its check box and click <span class="Name">OK</span>. This adds a tool for the Dual control to the VB Toolbox.</p><p>Click on the new tool and drag it onto your Form. An instance of the Dual control will appear.</p><p>Repeat this step to position a second instance of the Dual control on your VB Form.</p><p>Click the <span class="Name">Start Debugging</span> button.</p><p>Exercise the two Dual controls.</p><p>Click the <span class="Name">Stop Debugging</span>.button.</p><p>Click on one of the Dual controls and scroll through its Property list. Notice that all the properties listed are standard VB ones; there are no properties (or indeed methods and events) exported. We will learn how to do this next.</p><p>Close but <b>do not</b> save the project.</p><h4><a name="Defining_Properties"></a>Defining and Exporting Properties</h4><p>Start Dyalog APL and load the DUAL workspace (Hint: use the File menu; it will be the most recently saved file).</p><p>Change space into the <tt>F.Dual</tt> namespace.</p><pre>      )CS F.Dual</pre><p>The properties we wish to export are:
		</p><table><tr><td>Caption1</td><td>Description of the primary set of units</td></tr><tr><td>Caption2</td><td>Description of the secondary set of units</td></tr><tr><td>Value1</td><td>The primary value in the control</td></tr><tr><td>Min</td><td>Minimum for Value1</td></tr><tr><td>Max</td><td>Maximum for Value1</td></tr><tr><td>Intercept</td><td>Used to derive the secondary value (Value2)</td></tr><tr><td>Gradient</td><td>Used to derive the secondary value (Value2)</td></tr></table><p>Although we could export all these properties as variables, it is generally more useful to employ <span class="Name">Get</span> and <span class="Name">Put</span> functions. The reason for this is that there is no mechanism to detect when the host application changes a property/variable; nor is there any mechanism to prevent it assigning an inappropriate value. The <span class="Name">Get</span> and <span class="Name">Put</span> functions you need are listed below. To save you time, you can copy them in from the workspace DUALFNS.</p><pre>       )COPY SAMPLES\ACTIVEX\DUALFNS</pre><pre>     ∇ R←GetCaption1
[1]    R←Caption1
 
     ∇ SetCaption1 C
[1]    Cap1.Text←Caption1←C
 
     ∇ R←GetCaption2
[1]    R←Caption2
 
     ∇ SetCaption2 C
[1]    Cap2.Text←Caption2←C
 
     ∇ R←GetIntercept
[1]    R←Intercept
</pre><p class="pagebreakafter"> </p><pre>
     ∇ SetIntercept I
[1]    Intercept←I
[2]    CalcValue2
[3]    V2.Text←⍕Value2
 
     ∇ R←GetGradient
[1]    R←Gradient
 
     ∇ SetGradient G
[1]    Gradient←G
[2]    CalcValue2
[3]    V2.Text←⍕Value2
 
     ∇ R←GetValue1
[1]    R←Value1
 
     ∇ SetValue1 V
[1]    1 ⎕NQ'' 'ChangeValue'V</pre><p>The <tt>Get</tt> functions need no explanation; they simply return the value of the corresponding variable. The <tt>Set</tt> functions assign a new value to the corresponding variable and update the control accordingly. <tt>SetValue1</tt> does this by enqueuing a Scroll event to the Slider, which in turn invokes the <tt>ChangeValue</tt> callback.</p><p>Display the Object Properties dialog box for the function <tt>GetCaption1</tt>. (Hint: use the Workspace Explorer).</p><p>Select the <span class="Name">COM Properties</span> tab. As you have not yet defined any OLE attributes, the default display is as follows:
</p><p><img src="../images/dual-getcaption1-a.png" /></p><p>Check the <span class="Name">Exported</span> option button.</p><p>Change the data type for the <span class="Name">Result</span> to <span class="DataType">VT_BSTR</span>(a text string).</p><p>Check the <span class="Name">Prop Get</span> radio button to indicate that this is a <span class="Name">Property Get</span> function and enter the name of the property (<tt>Caption1</tt>) to which it applies.</p><p>Note that it is not necessary for the property name referenced by the <span class="Name">Get</span> and <span class="Name">Put</span> functions to correspond to a variable name, although in this case it does.</p><p>The final <span class="Name">COM Properties</span> dialog box for <tt>GetCaption1</tt> should appear as follows. Click<span class="Name"> OK </span>to save your changes.</p><p><img src="../images/dual-getcaption1-b.png" /></p><p>Now do the same for the <tt>SetCaption1</tt> function. This function takes an argument which it expects to be a character vector. It must therefore be defined as having a single parameter of data type <span class="DataType">VT_BSTR</span>; the parameter name is unimportant. However, you must ensure that the <span class="Name">Optional</span> button is unchecked.</p><p>In APL terms, the function does not return a result. However, in OLE terms the result is defined to be of type <span class="DataType">VT_VOID</span>. Alternatively, you may just leave this field empty.</p><p>The OLE properties for <tt>SetCaption1</tt> should appear as follows:</p><p><img src="../images/dual-setcaption1.png" /></p><p>An alternative way to define the syntax for exported functions is to use the <span class="Name">COM Functions</span> tab in the Properties dialog box for the ActiveXControl object itself. (Hint: using the Workspace Explorer, open <tt>F</tt> so that its contents, <tt>Dual</tt>, are displayed in the right-hand list, select <tt>Dual</tt>, then click <span class="Name">Props</span>). The <span class="Name">COM Functions</span> tab should appear as follows:</p><p><img src="../images/dual-com-functions-a.png" /></p><p>The right-hand Combo box allows you to view and edit their syntax for the exported functions you have already defined. The left-hand Combo box displays the list of other non-exported functions that are defined in the ActiveXControl.</p><p>Select <tt>GetCaption2</tt> from the left-hand Combo box, and then click <span class="Name">Add</span>. The dialog box will change to display the default syntax for <tt>GetCaption2</tt>. Alter the <span class="Name">Result</span> data type to <span class="DataType">VT_BSTR</span>, select <span class="Name">Prop Get</span>, and enter the name of the property, <tt>Caption2</tt>, so that the dialog box appears as follows:</p><p><img src="../images/dual-com-functions-b.png" /></p><p>The third way to define the syntax for exported functions is to use the SetFnInfo method of the ActiveXControl object. This allows you to export functions using APL code, which in some circumstances may be more convenient than filling in dialog boxes.</p><p>The SetFnInfo method requires the name of the function, its syntax, a help id, a code which specifies its type (0 = method, 2 = property get, 4 = property put) and, if appropriate, the name of the property to which it applies, i.e.</p><pre>      SetFnInfo fn syntax helpid type property</pre><p>The function <tt>syntax</tt> is a nested array whose first element defines the function’s result and whose subsequent elements define each of its parameters. Each syntax specifier is a single character string that defines a data type, or a pair of character strings. If so, the first string for the result defines a help string, and the first string for each parameter defines its name.</p><p>The following table describes the information we must specify for each of the functions to be exported:</p><p class="TableCaption"><span class="autonumber"><span>Table 63: </span></span>Exported Functions</p><table><tr><th rowspan="2" class="Left">Function</th><th rowspan="2" class="Left">Result</th><th colspan="2" class="Centre">Parameter</th><th rowspan="2" class="Left">Get/Put</th><th rowspan="2" class="Left">Property</th></tr><tr><th class="Left">Name</th><th class="Left">Type</th></tr><tr><td>GetCaption1</td><td>VT_BSTR</td><td> </td><td> </td><td>Get (2)</td><td>Caption1</td></tr><tr><td>GetCaption2</td><td>VT_BSTR</td><td> </td><td> </td><td>Get(2)</td><td>Caption2</td></tr><tr><td>GetGradient</td><td>VT_R8</td><td> </td><td> </td><td>Get(2)</td><td>Gradient</td></tr><tr><td>GetIntercept</td><td>VT_R8</td><td> </td><td> </td><td>Get(2)</td><td>Intercept</td></tr><tr><td>GetValue1</td><td>VT_I4</td><td> </td><td> </td><td>Get(2)</td><td>Value1</td></tr><tr><td>SetCaption1</td><td>VT_VOID</td><td>Caption1</td><td>VT_BSTR</td><td>Put(4)</td><td>Caption1</td></tr><tr><td>SetCaption2</td><td>VT_VOID</td><td>Caption2</td><td>VT_BSTR</td><td>Put(4)</td><td>Caption2</td></tr><tr><td>SetGradient</td><td>VT_VOID</td><td>Gradient</td><td>VT_R8</td><td>Put(4)</td><td>Gradient</td></tr><tr><td>SetIntercept</td><td>VT_VOID</td><td>Intercept</td><td>VT_R8</td><td>Put(4)</td><td>Intercept</td></tr><tr><td>SetValue1</td><td>VT_VOID</td><td>Value1</td><td>VT_I4</td><td>Put(4)</td><td>Value1</td></tr></table><p>From this table we can easily construct the corresponding SetFnInfo statements. For example, the statement for <tt>GetCaption1</tt> is:</p><pre>      SetFnInfo 'GetCaption1' 'VT_BSTR' ¯1 2 'Caption1'</pre><p>Note that <tt>¯1</tt> in the 3<sup>rd</sup> element of the right argument specifies that there is no help id.</p><p>Open the function <tt>F.Dual.EXPORT</tt>; this contains statements to export all of the <span class="Name">Get</span> and <span class="Name">Put</span> functions we need.</p><p>Run the function and save the workspace.</p><pre>      )CS
#
      F.Dual.EXPORT
      )SAVE</pre><p>Then, re-export the workspace, updating your .OCX file with all the new information.</p><h4><a name="Properties_VB"></a>Setting Properties from VB</h4><p>Close Dyalog APL.</p><p>Start VB and create a new Windows Forms Application Project.</p><p>Click the right mouse button in the General section of the Toolbox windowand select  <span class="Name">Choose Items ... </span>from the pop-up menu. In the <span class="Name">Choose Toolbox Items</span> dialog box, click the <span class="Name">COM Components</span> tab.</p><p>Locate the control named <span class="Name">Dyalog DUAL Control</span>,enable its check box and click <span class="Name">OK</span>. This adds a tool for the Dual control to the VB Toolbox.</p><p>Click on the new tool and drag it onto your Form. An instance of the Dual control will appear.</p><p>In the Properties dialog box, set the Dual1 properties as follows:</p><table><tr><td>Caption1</td><td>Centimetres</td></tr><tr><td>Caption2</td><td>Inches</td></tr><tr><td>Gradient</td><td>0.3937</td></tr><tr><td>Intercept</td><td>0</td></tr></table><p>Double-click the left mouse button over your Form (<span class="Name">Form1</span>). This will bring up the code editor dialog box. Edit the <span class="Code">Form_Load()</span> subroutine, entering the following program statements. This code will be run when VB starts your application and loads the Form <span class="Name">Form1</span>. It illustrates how you can change the properties of your Dyalog APL ActiveX control dynamically.</p><pre class="Code">Private Sub Form_Load()
Dual2.Caption1 = "Inches"
Dual2.Caption2 = "Centimetres"
Dual2.Intercept = 0
Dual2.Gradient = 2.54
End Sub</pre><p>Now test your application by clicking <span class="Name">Start Debugging</span>. When you have finished, click  <span class="Name">Stop Debugging</span>.</p><p>Close but <b>do not</b> save the project.</p><h4><a name="Defining_Events"></a>Defining and Exporting Events</h4><p>Start Dyalog APL and load the DUAL workspace (Hint: use the <span class="Name">File</span> menu; it will be the most recently saved file)</p><p>Using the Workspace Explorer, open the callback function <tt>F.Dual ChangeValue</tt> and alter <tt>ChangeValue[2]</tt> from:</p><pre>    Value1←⊃¯1↑MSG</pre><p>to</p><pre>    Value1←⊃4 ⎕NQ '' 'ChangeValue1' (⊃¯1↑MSG)</pre><p>Then close the function. Previously, the <tt>ChangeValue</tt> function simply accepted the new value (of the TrackBar thumb) that it received as the last element of the event message. Now it generates an external ChangeValue1 event for the host application using <tt>4 ⎕NQ</tt>. The host may in turn modify the new value which is returned as the result of the expression. Thus not only can Dyalog APL generate events which are detectable by the host application, it can also accept modifications.</p><p>Again using the Workspace Explorer, open the Properties dialog box for the Dual object itself and select the <span class="Name">COM Events</span> tab.</p><p>Enter the name of the event <tt>ChangeValue1</tt> into the edit box labelled <span class="Name">Name</span>.</p><p>Click <span class="Name">Add</span></p><p>Click the right mouse button over the <span class="Name">Result</span> row and select <span class="Name">Insert</span></p><p>Change the name <tt>Param1</tt> to <tt>Value1</tt>, the <span class="Name">Type</span> to <span class="DataType">VT_I4</span> and the <span class="Name">Modifier</span> to <span class="DataType">VT_PTR</span>. This defines the event to supply a pointer to an integer. The fact that it is a <span class="Italic">pointer</span> means that the (integer) parameter may be modified by the host application.</p><p>The final appearance of this dialog box should be as follows:</p><p><img src="../images/dual-com-events.png" /></p><p>Click <span class="Name">OK</span>, change back to the root space, and save the workspace.</p><pre>      )CS #
      )SAVE</pre><p>Select <span class="Name">File/Export</span> and rebuild your OCX file.</p><h4><a name="Events_VB"></a>Using Events from VB</h4><p>Start VB and create a new Windows Application Project.</p><p>Click the right mouse button in the General section of the Toolbox windowand select  <span class="Name">Choose Items ... </span>from the pop-up menu. In the <span class="Name">Choose Toolbox Items</span> dialog box, click the <span class="Name">COM Components</span> tab.</p><p>Locate the control named <span class="Name">Dyalog DUAL Control</span>, set its check box on and click <span class="Name">OK</span>. This adds a tool for the Dual control to the VB Toolbox.</p><p>Click on the new tool and drag it onto your Form. An instance of the Dual control will appear.</p><p>Select the label tool and add a label object to the Form. Select its Font property and change it to 14-point bold.</p><p>Double-click over <span class="Name">Dual1</span> to bring up the code window. Notice how VB presents you with a skeleton subroutine for the (only) event ChangeValue1 which we have just defined and exported. Notice too that VB knows that the single parameter is named Value1 and that its data type is Long (<span class="DataType">VT_I4</span>).</p><p>Enter the following code, and then close the code window.</p><pre class="Code">Private Sub Dual1_ChangeValue1(Value1 As Long)<br />Label1.Caption=Str(Value1)</pre><p>Start the application using <span class="Name">Start Debugging</span>. Exercise the Dual control and observe that VB updates the Label1 control in response to the ChangeValue1 events. When you have finished, select <span class="Name">Stop Debugging</span>.</p><p>Double-click over <span class="Name">Dual1</span> to bring up the code window. Alter the Dual1_ChangeValue subroutine to the following, and then close the code window.</p><pre class="Code">Private Sub Dual1_ChangeValue1(Value1 As Long)<br />Value1=2*(Value1\2)<br />Label1.Caption=Str(Value1)<br />End Sub</pre><p>Start the application using <span class="Name">Start Debugging</span>. Exercise the Dual control and observe that now the slider moves in increments of 2. When you have finished, select <span class="Name">Stop Debugging</span>.</p><p>Close but <b>do not</b> save the project.</p><h4><a name="Dual)WebPage"></a>Using Dual in a Web Page</h4><p>This part of the tutorial can be run using any Web Browser that supports ActiveX.</p><p>Start Dyalog APL and load the DUAL workspace again.</p><pre>      )LOAD DUAL
      )CS F.Dual</pre><p>Look at the function <tt>WRITE_HTML</tt>. This function writes a very simple page of HTML that loads your Dyalog APL ActiveX control. The left argument to the function is a title for the page; the right argument is the full pathname for the file. The function references the control by embedding its ClassID in the HTML document.</p><p>Now run it:</p><pre>       'Dyalog Dual Control' WRITE_HTML 'dual.htm'</pre><p>Close Dyalog APL</p><p>Start your Web Browser and point it at the file you have just saved by typing the URL: <span class="Code">file://c:\...dyalog...\dual.htm</span></p><p>Close your browser</p><h4><a name="Dual_VBScript"></a>Calling Dual from VBScript</h4><p>In the last part of this tutorial, you will learn how you can manipulate the Dual control from VBScript in a web page.</p><p>For this example, we first need to export the Value2 property. This property is only required to be <span class="Italic">read</span> (not set) by the VBScript program. Therefore there is no need for it to be accessed via <span class="Name">Get</span> and <span class="Name">Put</span> functions and it can be exported (more simply) as a variable.</p><p>Start Dyalog APL and load the DUAL workspace again.</p><pre>      )LOAD DUAL</pre><p>Using the <span class="Name">Workspace Explorer</span>, display the <span class="Name">Object Properties</span> dialog box for the variable <tt>Value2</tt>.</p><p>Select the <span class="Name">COM Properties</span> tab. As you have not yet defined any OLE attributes, the default display is as follows:</p><p><img src="../images/dual-value2-a.png" /></p><p>Check the <span class="Name">Exported</span> option button, and change the data type to <span class="DataType">VT_R8</span>. This is important because unlike <tt>Value1</tt>, which is an integer, <tt>Value2</tt> may be floating-point and it must be declared as such. The resulting dialog box should appear as below; click <span class="Name">OK</span> to save these settings.</p><p><img src="../images/dual-value2-b.png" /></p><p>The VBScript program is going to need to know whenever the derived value, Value2, changes, Therefore, the next step is to define the code to generate a ChangeValue2 event and export it. ChangeValue2 is to be generated whenever Value2 has changed, so the place to put it is immediately after Value2 is recalculated in <tt>CalcValue2</tt>.</p><p>Edit <tt>F.Dual.CalcValue2</tt> so that it reads as follows:</p><pre>     ∇ CalcValue2;SINK
[1]    Value2←Intercept+Gradient×Value1
[2]    :If ~(⊂'Create')∊⎕SI
[3]        SINK←4 ⎕NQ'' 'ChangeValue2'Value2
[4]    :EndIf
     ∇</pre><p>Note that the function deliberately avoids generating the ChangeValue2 event when the instance is created. It can tell when this happens because during creation it will have been called by the Create function. (We could have instead have called CalcValue2 with an argument, but this will suffice.) This is necessary only because the simple VBScript example is unable to handle events during object creation</p><p>You can export the CalcValue2 event using the <span class="Name">COM Events</span> tab on the <span class="Name">Properties</span> dialog box for <tt>F.Dual</tt>. However, you can also export the event using the SetEventInfo method.</p><p>Type the following:</p><pre>      INFO←'VT_VOID'('Value2' 'VT_R8')
      2 ⎕NQ'#.F.Dual' 'SetEventInfo' 'ChangeValue2' INFO</pre><p>(You may wish to confirm that the event is registered correctly using the dialog box)</p><p>Save the workspace:</p><pre>      )CS #
      )SAVE</pre><p>Finally, you need to rebuild the OCX file to reflect these changes, so select File/Export and rebuild your OCX file.</p><p>The HTML page containing the example VBScript program is supplied in the file <span class="Code">samples\activex\dualvb.htm</span>. However, the Dual object to which the HTML refers (via its ClassID) is not the same object as <span class="Italic">your</span> Dual object which has its own unique ClassID. We must update the file, changing the existing ClassID to the ClassID of your own Dual object. You can do this using the <tt>UPDATE_CLASSID</tt>.</p><p>Look at the function <tt>F.Dual.UPDATE_CLASSID</tt>. This function simply updates an HTML file with the ClassID of the current (ActiveXControl) namespace.</p><pre>     ∇ {NEW}UPDATE_CLASSID FILE;NID;HTML;CLASSID;I
[1]    ⍝ Updates HTML file, replacing all object
[2]    ⍝ references with the ClassID of the current
[3]    ⍝ (ActiveXControl) namespace.
[4]    ⍝ Optional left argument is the name of the
[5]    ⍝ new HTML file. If omitted, it updates the
[6]    ⍝ file in-situ.
[7]
[8]    NID←FILE ⎕NTIE 0
[9]    HTML←⎕NREAD NID,82,(⎕NSIZE NID),0
[10]   :If 2=⎕NC'NEW'
[11]       ⎕NUNTIE NID
[12]       :Trap 22
[13]           NID←NEW ⎕NCREATE 0
[14]       :Else
[15]           NID←NEW ⎕NTIE 0
[16]       :EndTrap
[17]   :EndIf
[18]   I←'clsid:'⍷{
[19]       ⎕AV[(⎕AV⍳⍵)-48×⍵∊⎕A]
[20]   }HTML
[21]   I←I/⍳⍴I
[22]   :If ×⍴I
[23]       I+←5
[24]       CLASSID←1↓¯1↓⎕WG'ClassID'
[25]       HTML[,I∘.+⍳⍴CLASSID]←((⍴I)×⍴CLASSID)⍴CLASSID
[26]       HTML ⎕NREPLACE NID 0
[27]   :EndIf
[28]   ⎕NUNTIE NID
     ∇</pre><p>Now run the function, making a new dualvb.htm file in your current directory.</p><pre>   )CS #.F.Dual
   'dualvb.htm' UPDATE_CLASSID 'samples\activex\dualvb.htm'</pre><p>Close Dyalog APL.</p><p>Start your Web Browser and point it at the file you have just saved by typing the URL: <span class="Code">file://c:\...dyalog...\dualvb.htm</span></p><p>The Web page displays two instances of your Dual control, one called <span class="Name">plank_length</span> labelled <span class="Name">Length</span> (Metres to Centimetres) and the other named <span class="Name">plank_width</span> and labelled <span class="Name">Width </span>(Inches to Centimetres). The initialisation of these controls is performed by the <span class="Code">window_onload()</span>which is run when the page is loaded into the Web Browser.</p><p class="pagebreakafter"> </p><pre class="Code">Sub window_onload()
plank_length.Caption1 = "Metres"
plank_length.Caption2 = "Centimetres"
plank_length.Gradient = 100
plank_length.Intercept = 0
plank_width.Caption1 = "Inches"
plank_width.Caption2 = "Centimetres"
plank_width.Gradient = 2.54
plank_width.Intercept = 0
end sub</pre><p>Whenever you change one of these dimensions, the corresponding Dual control generates a ChangeValue2 event after the derived value (Value2) in centimetres is recalculated. Each of the Dual controls has a VBScript callback function attached which calculates the new area. These are as follows:</p><pre class="Code">Sub plank_length_ChangeValue2(Value2)
Result.Plank_Area.value = Value2 * plank_width.Value2
end sub
 
Sub plank_width_ChangeValue2(Value2)
Result.Plank_Area.value=Value2 * plank_length.Value2
end sub</pre><p>When you have finished exercising the two Dual controls, close your Web Browser.</p><script src="../../../help.js"></script></body>
</html>