<!doctype html>
<html>
<head><meta charset="utf-8"><title></title><link rel="stylesheet" href="../../help.css"></head>
<body><h2 class="Newpage"><span class="DyalogPlain">⎕NA</span> under UNIX</h2><p> </p><h4>Introduction</h4><p><span class="DyalogPlain">⎕NA</span> is fully supported under UNIX; the Conga communications package for example is a shared library on all platforms.</p><p><span class="DyalogPlain">⎕NA</span> supports user-written shared libraries and also system-supplied shared libraries. Dyalog APL under UNIX is supplied with a shared library, dyalog32.so or dyalog64.so which contains the same functions as the DLLs which are described in the <span class="DyalogPlain">⎕NA</span> documentation in the <span class="Name">Dyalog APL Language Reference</span>. Additionally, the function <span class="DyalogPlain">getlasterror</span> is included; this returns the error code at the point when the called function failed (which may be different from its value at the point where a previous error occurred).</p><p>It is necessary to specify the complete name of the file containing the shared library, no extension is added by Dyalog APL. </p><p>When developing code using <span class="DyalogPlain">⎕NA</span> it may be useful to set the environment variable ERRORONEXTERNALEXCEPTION= 1. When this is set, Dyalog APL will generate an event 91, <tt>EXTERNAL DLL EXCEPTION</tt> rather than a syserror should a call on a functions defined by <span class="DyalogPlain">⎕NA</span> be ill-specified. It should be noted however that the workspace may become corrupt, so it is not recommended to run in production with this variable set.</p><h4>System Shared Libraries</h4><p>On AIX many system library functions appear in libc.a.</p><p>When calling system shared libraries under AIX, you must refer to them as:</p><p>64-bit: libc.a(shr_64.o)</p><p>32-bit: libc.a(shr.o)</p><p>It is not always possible to access all library functions - on AIX for example it is not possible to access memcpy() or strncpy(). it is for this reason that dyalog*.so includes MEMCPY and STRNCPY.</p><p>On Linux, it is a little more difficult to location the libc.so file; the function <span class="DyalogPlain">libc</span> in the supplied workspace quadna can be used to locate this file.</p><h4 class="ExampleNewPage">Definitions</h4><p>In the remainder of this section references are made to the APL variables <span>sharedlib</span> and <span class="DyalogPlain">dyalib</span>; the definitions for both vary  between AIX and Linux, and between 32 and 64 bit interpreters. </p><p>Under AIX, <span class="DyalogPlain">sharedlib</span> is defined as:</p><pre>
      sharedlib←'libc.a(shr_64.o)' ⍝ 64 bit
      sharedlib←'libc.a(shr.o)'    ⍝ 32 bit  
	</pre><p>Under Linux, it is necessary to identify the shared library:</p><pre>
      )copy quadna libc
      sharedlib←libc ⍬</pre><p>For all UNIX platforms, the dyalog shared library is identified as</p><pre>
      dyalib←'dyalog64.so'         ⍝ 64 bit
      dyalib←'dyalog32.so'         ⍝ 32 bit
		</pre><h4>Example 1</h4><p>getpid() is common to all UNIX platforms; it returns an int which is the process ID of the current process. It is defined to be</p><p>pid_t getpid(void)</p><p>where pid_t is a 4-byte integer.</p><p>The APL code to instantiate this function is</p><pre>
      ⎕na 'I4 ',sharedlib,'|getpid'
		</pre><h4>Example 2</h4><p>This is a slightly more complex example, which uses the STRNCPY function in the Dyalog-supplied shared library to retrieve the value of a variable which is referenced by a pointer, returned from the system library function:</p><p>getenv()returns a pointer to the value of the environment variable which is the argument of the function. It is defined to be</p><p>char *getenv(const char *name)</p><pre>
      ∇r←GetEnv envvar;getenv;P;get
       r←''
       ⎕NA'P ',sharedlib,'|getenv &lt;0T1[]'
       'get'⎕NA dyalib,'|STRNCPY &gt;0U1[] P U4'
       P←getenv⊂'UTF-8'⎕UCS ⎕UCS envvar
       →0⍴⍨P=0
       r←'UTF-8'⎕ucs get 4096 P 4096
      ∇

      GetEnv'MAXWS'
4G
		</pre><p>Note: the call to STRNCPY has been defined to return a vector of integers so that the result can be passed directly to <tt>⎕UCS</tt>. </p><h4>geterrno</h4><p>The dyalog shared libary under UNIX includes the function <span class="DyalogPlain">geterrno</span>. This returns the current value of errno; be aware that it may not have the same value as at the point when the error was raised. To use this function:</p><pre>
      ⎕na 'I ',dyalib','|geterrno'
      geterrno
5
      		</pre><h4>Shared libraries and APL threads</h4><p>Any shared library function must mask out all signals for  new threads which it creates. Failure to do so will result in a catastrophic failure of APL's signal handling.</p><p> </p></body>
</html>