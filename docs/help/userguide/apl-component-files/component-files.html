<!doctype html>
<html>
<head><meta charset="utf-8"><title></title><link rel="stylesheet" href="../../../help.css"></head>
<body><h2><a name="Component_Files"></a>Component Files</h2><h4><a name="Overview"></a>Overview</h4><p>A <b>component file</b> is a data file maintained by Dyalog APL. It contains a series of APL arrays known as <b>components</b> which are accessed by reference to their relative position or <b>component number</b> within the file. Component files are just like other data files and there are no special restrictions imposed on names or sizes.</p><p>A set of system functions is supplied to perform a range of file operations. These provide facilities to create or delete files, and to read and write components. Facilities are also provided for multi-user access, including the capability to determine who may do what, and file locking for concurrent updates.</p><h4><a name="Tying)UnTying"></a>Tying and Untying Files</h4><p>To access an existing component file it must be <b>tied</b>, i.e. opened for use. The tie may be <b>exclusive</b> (single-user access) or <b>shared</b> (multi-user access). A file is <b>untied</b>, i.e. closed, using <tt>⎕FUNTIE</tt> or on terminating Dyalog APL. File ties survive <tt>)LOAD</tt>, <tt>⎕LOAD</tt> and <tt>)CLEAR</tt> operations.</p><h4><a name="Tie_Numbers"></a>Tie Numbers</h4><p>A file is tied by associating a <b>file name</b> with a <b>tie number</b>. Tie numbers are integers in the range 1 - 2147483647 and, you can supply one explicitly, or have the interpreter allocate the next available one by specifying 0. The system functions which tie files return the tie number as a ‘shy’ result.</p><h4><a name="Creating_Removing_Files"></a>Creating and Removing Files</h4><p>A component file is created using <tt>⎕FCREATE</tt> which automatically ties the file for exclusive use. A newly created file is empty, i.e. contains 0 components. A file is removed with <tt>⎕FERASE</tt>, although it must be exclusively tied to do so.</p><h4><a name="Adding_Removing_Components"></a>Adding and Removing Components</h4><p>Components are added to a file using <tt>⎕FAPPEND</tt> and removed using <tt>⎕FDROP</tt>. Component numbers are allocated consecutively starting at 1. Thus a new component added by <tt>⎕FAPPEND</tt> is given a component number which is one greater that that of the last component in the file. Components may be removed from the beginning or end of the file, but not from the middle. Component numbers are therefore contiguous.</p><h4><a name="Reading_Writing_Components"></a>Reading and Writing Components</h4><p>Components are read using <tt>⎕FREAD</tt> and overwritten using <tt>⎕FREPLACE</tt>. There are no restrictions on the size or type of array which may replace an existing component. Components are accessed by component number, and may be read or overwritten at random.</p><h4><a name="Component_Information"></a>Component Information</h4><p>In addition to the data held in a component, the user ID that wrote it and the time at which it was written is also recorded. This control information is useful in providing an audit trail and in facilitating partial backups of components that have changed.</p><h4><a name="MultiUser_Access"></a>Multi-User Access</h4><p><tt>⎕FSTIE</tt> ties a file for <b>shared</b> (i.e. multi-user) access. This kind of access would be appropriate for a multi-user UNIX system, a network of single user PCs, or multiple APL tasks under Microsoft Windows.</p><p><tt>⎕FHOLD</tt> provides the means for the user to temporarily prevent other co-operating users from accessing one or more files. This is necessary to allow a single logical update involving more than one component, and perhaps more than one file, to be completed without interference from another user. <tt>⎕FHOLD</tt> is applicable to External Variables as well as Component Files</p><h4><a name="File_Access_Control"></a>File Access Control</h4><p>There are two levels of file access control. As a regular data file, the operating system read/write controls for owner and other users apply. In addition, Dyalog APL manages its own access controls using the <b>access matrix</b>. This is an integer matrix with 3 columns and any number of rows. Column 1 contains user numbers, column 2 an encoding of permitted file operations, and column 3 passnumbers. Each row specifies which file operations may be performed by which user(s) with which passnumber.</p><h4>User Number</h4><p>This is a number which is defined by the <span class="Parameter">aplnid</span> parameter.   If you intend to use Dyalog APL’s <b>access matrix</b> to control file access in a multi-user environment, it is desirable to allocate to each user, a distinct <b>user number</b>. However, if you intend to rely on under-lying operating system controls, allocating a user number of 0 to everyone is more appropriate. A user number of 0 (which is the installation default), causes APL to circumvent the access matrix mechanism described below.</p><h4>Permission Code</h4><p>This is an integer representation of a Boolean mask. Each bit in the mask indicates whether or not a particular file operation is permitted as follows:</p><pre>
┌──┬──┬──┬──┬──┬──┬─┬─┬─┬─┬─┬─┬─┬─┬─┐ Bit No.
│15│14│13│12│11│10│9│8│7│6│5│4│3│2│1│
└──┴──┴──┴──┴──┴──┴─┴─┴─┴─┴─┴─┴─┴─┴─┘  File      Access
  ↑  ↑  ↑  ↑  ↑  ↑   ↑   ↑ ↑ ↑ ↑ ↑ ↑   Operation   Code
  │  │  │  │  │  │   │   │ │ │ │ │ │
  │  │  │  │  │  │   │   │ │ │ │ │ └── ⎕FREAD         1
  │  │  │  │  │  │   │   │ │ │ │ └──── ⎕FTIE          2
  │  │  │  │  │  │   │   │ │ │ └────── ⎕FERASE        4
  │  │  │  │  │  │   │   │ │ └──────── ⎕FAPPEND       8
  │  │  │  │  │  │   │   │ └────────── ⎕FREPLACE     16
  │  │  │  │  │  │   │   └──────────── ⎕FDROP        32
  │  │  │  │  │  │   │
  │  │  │  │  │  │   └──────────────── ⎕FRENAME     128
  │  │  │  │  │  │
  │  │  │  │  │  └──────────────────── ⎕FRDCI       512
  │  │  │  │  └─────────────────────── ⎕FRESIZE    1024
  │  │  │  └────────────────────────── ⎕FHOLD      2048
  │  │  └───────────────────────────── ⎕FRDAC      4096
  │  └──────────────────────────────── ⎕FSTAC      8192
  └─────────────────────────────────── ⎕FHIST     16384</pre><p>For example, if bits 1, 4 and 6 are set and all other relevant bits are zero only <tt>⎕FREAD</tt>, <tt>⎕FAPPEND</tt> and <tt>⎕FDROP</tt> are permitted. A convenient way to set up the mask is to sum the access codes associated with each operation.</p><p>For example, the value 41 (1+8+32) authorises <tt>⎕FREAD</tt>, <tt>⎕FAPPEND</tt> and <tt>⎕FDROP</tt>. A value of <tt>¯1</tt> (all bits set) permits all operations. Thus by subtracting the access codes of operations to be forbidden, it is possible to permit all but certain types of access. For example, a value of <tt>¯133</tt> (<tt>¯1- 4+128</tt>) permits all operations except <tt>⎕FERASE</tt> and <tt>⎕FRENAME</tt>. Note that the value of unused bits is ignored. Any non-zero permission code allows <tt>⎕FSTIE</tt> and <tt>⎕FSIZE</tt>. <tt>⎕FCREATE</tt>, <tt>⎕FUNTIE</tt>, <tt>⎕FLIB</tt>, <tt>⎕FNAMES</tt> and <tt>⎕FNUMS</tt> are not subject to access control. Passnumbers may also be used to establish different levels of access for the same user.</p><p>When the user attempts to tie a file using <tt>⎕FTIE</tt> or <tt>⎕FSTIE</tt> a row of the access matrix is selected to control this and subsequent operations.</p><p>If the user is the owner, and the owner's user ID does not appear in the access matrix, the value (<tt>⎕AI[1] ¯1 0</tt>) is conceptually appended to the access matrix. This ensures that the owner has full access rights unless they are explicitly restricted.</p><p>The chosen row is the first row in which the value in column 1 of the access matrix matches the user ID and the value in column 3 matches the supplied passnumber which is taken to be zero if omitted.</p><p>If there is no match of user ID and passnumber in the access matrix (including implicitly added rows) then no access is granted and the tie fails with a FILE ACCESS ERROR.</p><p>Once the applicable row of the access matrix is selected, it is used to verify all subsequent file operations. The passnumber used to tie the file MUST be used for every subsequent operation. Secondly, the appropriate bit in the permission code corresponding to the file operation in question must be set. If either of these conditions is broken, the operation will fail with <tt>FILE ACCESS ERROR</tt>.</p><p>If the access matrix is changed while a user has the file tied, the change takes immediate effect. When the user next attempts to access the file, the applicable row in the access matrix will be reselected subject to the supplied passnumber being the same as that used to tie the file. If access with that password is rescinded the operation will fail with <tt>FILE ACCESS ERROR</tt>.</p><p>When a file is created using <tt>⎕FCREATE</tt>, the access matrix is empty. At this stage, the owner has full access with passnumber 0, but no access with a non-zero passnumber. Other users have no access permissions. Thus only the owner may initialise the access matrix.</p><h4><a name="User0"></a>User 0</h4><p>If a user has an <span class="Parameter">aplnid</span> of 0, the access matrix and supplied passnumbers are ignored. This user is granted full and unrestricted access rights to all component files, subject only to underlying operating system restrictions.</p><h4><a name="General_Operations"></a>General File Operations</h4><p><tt>⎕FLIB</tt> gives a list of <b>component files</b> in a given directory. <tt>⎕FNAMES</tt> and <tt>⎕FNUMS</tt> give a list of the names and tie numbers of tied files. These general operations which apply to more than one file are not subject to access controls.</p><h4><a name="_Toc289335850"></a>Component File System Functions</h4><p>See <span class="Name">Language Reference</span> for full details of the syntax of these system functions.</p><table><tr><td colspan="2" class="SubHeading">General</td></tr><tr><td><tt>⎕FAVAIL</tt></td><td>Report file system availability</td></tr><tr><td colspan="2" class="SubHeading">File Operations</td></tr><tr><td><tt>⎕FCREATE</tt></td><td>Create a file</td></tr><tr><td><tt>⎕FTIE</tt></td><td>Tie an existing file (exclusive)</td></tr><tr><td><tt>⎕FSTIE</tt></td><td>Tie an existing file (shared)</td></tr><tr><td><tt>⎕FUNTIE</tt></td><td>Untie file(s)</td></tr><tr><td><tt>⎕FCOPY</tt></td><td>Copy a file</td></tr><tr><td><tt>⎕FERASE</tt></td><td>Erase a file</td></tr><tr><td><tt>⎕FRENAME</tt></td><td>Rename a file</td></tr><tr><td colspan="2" class="SubHeading">File information</td></tr><tr><td><tt>⎕FHIST</tt></td><td>Report file events</td></tr><tr><td><tt>⎕FNUMS</tt></td><td>Report tie numbers of tied files</td></tr><tr><td><tt>⎕FNAMES</tt></td><td>Report names of tied files</td></tr><tr><td><tt>⎕FLIB</tt></td><td>Report names of component files</td></tr><tr><td><tt>⎕FPROPS</tt></td><td>Report file properties</td></tr><tr><td><tt>⎕FSIZE</tt></td><td>Report size of file</td></tr><tr><td colspan="2" class="SubHeading">Writing to the file</td></tr><tr><td><tt>⎕FAPPEND</tt></td><td>Append a component to the file</td></tr><tr><td><tt>⎕FREPLACE</tt></td><td>Replace an existing component</td></tr><tr><td colspan="2" class="SubHeading">Reading from a file</td></tr><tr><td><tt>⎕FREAD</tt></td><td>Read one or more components</td></tr><tr><td><tt>⎕FRDCI</tt></td><td>Read component information</td></tr><tr class="pagebreakbefore"><td colspan="2" class="SubHeading">Manipulating a file</td></tr><tr><td><tt>⎕FDROP</tt></td><td>Drop a block of components</td></tr><tr><td><tt>⎕FRESIZE</tt></td><td>Change file size (forces a compaction)</td></tr><tr><td><tt>⎕FCHK</tt></td><td>Check and repair a file</td></tr><tr><td colspan="2" class="SubHeading">Access manipulation</td></tr><tr><td><tt>⎕FSTAC</tt></td><td>Set file access matrix</td></tr><tr><td><tt>⎕FRDAC</tt></td><td>Read file access matrix</td></tr><tr><td colspan="2" class="SubHeading">Control multi-user access</td></tr><tr><td><tt>⎕FHOLD</tt></td><td>Hold file(s) - see later section for details</td></tr></table><h4><a name="Using_Component_Files"></a>Using the Component File System</h4><p>Let us suppose that you have written an APL system that builds a personnel database, containing the name, age and place of birth of each employee. Let us assume that you have created a variable <tt>DATA</tt>, which is a nested vector with each element containing a person's name, age and place of birth:</p><pre class="APLCodeSmall">      DISPLAY 2↑DATA
.→-------------------------------------------------------.
| .→----------------------. .→-------------------------. |
| | .→-------.    .→----. | | .→------.    .→--------. | |
| | |Jonathan| 42 |Wales| | | |Pauline| 21 |Isleworth| | |
| | '--------'    '-----' | | '-------'    '---------' | |
| '∊----------------------' '∊-------------------------' |
'∊-------------------------------------------------------'</pre><p>Then the following APL expressions can be used to access the database:</p><h4>Example 1: </h4><p>Show record 2</p><pre>      DISPLAY 2⊃DATA
.→-------------------------.
| .→------.    .→--------. |
| |Pauline| 21 |Isleworth| |
| '-------'    '---------' |
'∊-------------------------'</pre><h4>Example 2: </h4><p>How many people in the database?</p><pre>           ⍴DATA
     123</pre><h4 class="ExampleNewPage">Example 3: </h4><p>Update Pauline's age</p><pre>           (2 2⊃DATA)←16</pre><h4>Example 4: </h4><p>Add a new record to the database</p><pre>      DATA ,← ⊂'Maurice' 18 'London'</pre><p>Now let's build a component file to hold our personnel database.</p><p>Create a new file, giving the file name, and the number you wish to use to identify it (the file tie number):</p><pre>      'COMPFILE' ⎕FCREATE 1</pre><p>If the file already exists, or you have already used this tie number, then APL will respond with the appropriate error message.</p><p>Now write the data to the file. We could write a function that loops to do this, but it is neater to take advantage of the fact that our data is a nested vector, and use each (<tt>¨</tt>).</p><pre>      DATA ⎕FAPPEND¨ 1</pre><p>Now we'll try our previous examples using this file.</p><h4>Example 1: </h4><p>Show record 2</p><pre>      DISPLAY ⎕FREAD 1 2
.→-------------------------.
| .→------.    .→--------. |
| |Pauline| 21 |Isleworth| |
| '-------'    '---------' |
'∊-------------------------'
</pre><h4>Example 2: </h4><p>How many people in our database?</p><pre>      ⎕FSIZE 1        ⍝ First component, next
1 125 10324 4294967295  ⍝ component, file size,
                        ⍝ maximum file size</pre><pre>      ¯1+2⊃⎕FSIZE 1   ⍝ Number of data items</pre><p>The fourth element of <tt>⎕FSIZE</tt> indicates the file size limit. Dyalog APL does not impose a file size limit, although your operating system may do so, but the concept is retained in order to make this version of Component Files compatible with others.</p><h4 class="ExampleNewPage">Example 3: </h4><p>Update Pauline's age</p><pre>        REC ← ⎕FREAD 1 2       ⍝ Read second component
        REC[2] ← 18            ⍝ Change age
        REC ⎕FREPLACE 1 2      ⍝ And replace component</pre><h4>Example 4: </h4><p>Add a new record</p><pre>       ('Janet' 25 'Basingstoke') ⎕FAPPEND 1</pre><h4>Example 5: </h4><p>Rename our file</p><pre>       'PERSONNEL' ⎕FRENAME 1</pre><h4>Example 6: </h4><p>Tie an existing file; give file name and have the interpreter allocate the next available tie number.</p><pre>       'SALARIES' ⎕FTIE 0
  2</pre><h4>Example 7: </h4><p>Give everyone access to the PERSONNEL file</p><pre>       (1 3⍴0 ¯1 0)⎕FSTAC 1</pre><h4>Example 8:  </h4><p>Set different permissions on <tt>SALARIES</tt>.</p><pre>       AM ← 1 3⍴1 ¯1 0    ⍝ Owner ID 1 has full access
       AM⍪← 102 1 0       ⍝ User ID 102 has READ only
       AM⍪← 210 2073 0    ⍝ User ID 210 has
                           ⍝ READ+APPEND+REPLACE+HOLD</pre><pre>       AM ⎕FSTAC 2        ⍝ Store access matrix</pre><h4>Example 9:  </h4><p>Report on file names and associated numbers</p><pre>        ⎕FNAMES,⎕FNUMS
 PERSONNEL  1
 SALARIES   2</pre><h4 class="ExampleNewPage">Example 10: </h4><p>Untie all files</p><pre>       ⎕FUNTIE ⎕FNUMS</pre><script src="../../../help.js"></script></body>
</html>