<!doctype html>
<html>
<head><meta charset="utf-8"><title></title><link rel="stylesheet" href="../../../../help.css"></head>
<body><h3>Threads &amp; External Functions</h3><p>External functions in dynamic link libraries (DLLs) defined using the <tt>⎕NA</tt> interface may be run in separate C threads. Such threads:</p><ul><li value="1"><b>take advantage of multiple processors</b> if the operating system permits.</li><li value="2">allow APL to <b>continue processing in parallel</b> during the execution of a <tt>⎕NA</tt> function. </li></ul><p>When you define an external function using <tt>⎕NA</tt>, you may specify that the function be run in a separate C thread by appending an ampersand (&amp;) to the function name, for example:</p><pre>      'beep'⎕NA'user32|MessageBeep&amp; i'    
      ⍝ MessageBeep will run in a separate C thread</pre><p>When APL first comes to execute a multi-threaded <tt>⎕NA</tt> function, it starts a new C-thread, executes the function within it, and waits for the result. Other APL threads may then run in parallel.</p><p>Note that when the <tt>⎕NA</tt> call finishes and returns its result, its new C-thread is retained to be re-used by any subsequent multithreaded <tt>⎕NA</tt> calls made within the same APL thread. Thus any APL thread that makes any multi-threaded <tt>⎕NA</tt> calls maintains a separate C-thread for their execution. This C-thread is discarded when its APL thread finishes.</p><p>Note that there is no point in specifying a <tt>⎕NA</tt> call to be multi-threaded, unless you wish to execute other APL threads at the same time.</p><p>In addition, if your <tt>⎕NA</tt> call needs to access an APL GUI object (strictly, a window or other handle) it should normally run within the same C-thread as APL itself, and not in a separate C-thread. This is because Windows associates objects with the C-thread that created them. Although you <span class="Italic">can</span> use a multi-threaded <tt>⎕NA</tt> call to access (say) a Dyalog APL Form via its window handle, the effects may be different than if the <tt>⎕NA</tt> call was not multi-threaded. In general, <tt>⎕NA</tt> calls that access APL (GUI) objects should not be multi-threaded.</p><p>If you wish to run the same <tt>⎕NA</tt> call in separate APL threads at the same time, you must ensure that the DLL is <span class="Italic">thread-safe</span>. Functions in DLLs which are not <span class="Italic">thread-safe</span>, must be prevented from running concurrently by using the <tt>:Hold</tt> control structure. Note that all the standard Windows API DLLs <b>are </b><span class="Italic">thread safe</span>.</p><p>Notice that you may define two separate functions (with different names), one single-threaded and one multi-threaded, associated with the same function in the DLL. This allows you to call it in either way.</p></body>
</html>