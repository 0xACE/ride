<!doctype html>
<html>
<head><meta charset="utf-8"><title></title><link rel="stylesheet" href="../../../help.css"></head>
<body><h2><tt>:Hold tkns</tt>Hold Statement</h2><p><span class="MCPopup"><a href="javascript:void(0);" onclick="FMCPopup( event, this ); return false;" class="MCPopupSpot"><span class="MCPopup"><a href="javascript:void(0);" onclick="FMCPopup( event, this ); return false;" class="MCPopupSpot">Formal Definition</a></span></a></span></p><p>Whenever more than one thread tries to access the same piece of data or shared resource at the same time, you need some type of synchronisation to control access to that data. This is provided by <tt>:Hold</tt>. </p><p><tt>:Hold</tt> provides a mechanism to control thread entry into a critical section of code. <tt>tkns</tt> must be a simple character vector or scalar, or a vector of character vectors. <tt>tkns</tt> represents a set of ‘tokens’, all of which must be acquired before the thread can continue into the control structure. <tt>:Hold</tt> is analogous to the component file system <tt>⎕FHOLD</tt>.</p><p>Within the whole active workspace, a token with a particular value may be held only once. If the hold succeeds, the current thread <span class="Italic">acquires </span>the tokens and execution continues with the first phrase in the control structure. On exit from the structure, the tokens are released for use by other threads. If the hold fails, because one or more of the tokens is already in use:</p><ol><li value="1">If there is no <tt>:Else</tt> clause in the control structure, execution of the thread is blocked until the requested tokens become available.</li><li value="2">Otherwise, acquisition of the tokens is abandoned and execution resumed immediately at the first phrase in the <tt>:Else</tt> clause.</li></ol><p><tt>tkns</tt> can be either a single token:</p><pre>    'a'
    'Red'
    '#.Util'
    ''
    'Program Files'</pre><p>… or a number of tokens:</p><pre>    'red' 'green' 'blue'
    'doe' 'a' 'deer'
    ,¨'abc'
    ↓⎕nl 9</pre><p>Pre-processing removes trailing blanks from each token before comparison, so that, for example, the following two statements are equivalent:</p><pre>    :Hold 'Red' 'Green' 
    :Hold ↓2 5⍴'Red  Green'</pre><p>Unlike <tt>⎕FHOLD</tt>, a thread does not release all existing tokens before attempting to acquire new ones. This enables the nesting of holds, which can be useful when multiple threads are concurrently updating parts of a complex data structure.</p><p>In the following example, a thread updates a critical structure in a child namespace, and then updates a structure in its parent space. The holds will allow all ‘sibling’ namespaces to update concurrently, but will constrain updates to the parent structure to be executed one at a time.</p><pre>    :Hold ⎕cs''          ⍝ Hold child space     
        ...              ⍝ Update child space
        :Hold ##.⎕cs''   ⍝ Hold parent space 
            ...          ⍝ Update Parent space
        :EndHold
        ...
    :EndHold</pre><p>However, with the nesting of holds comes the possibility of a ‘deadlock’. For example, consider the two threads:</p><table><tr><th class="Left">Thread 1</th><th class="Left">Thread 2</th></tr><tr><td><pre>:Hold 'red'
    ...
    :Hold 'green'
        ...
    :EndHold
:EndHold
</pre></td><td><pre>:Hold 'green'
    ...
    :Hold 'red' 
        ...
    :EndHold
:EndHold</pre></td></tr></table><p>In this case if both threads succeed in acquiring their first hold, they will both block waiting for the other to release its token. </p><p>If this deadlock situation is detected acquisition of the tokens is abandoned. Then:</p><ol><li value="1">If there is an <tt>:Else</tt> clause in the control structure,  execution jumps to the <tt>:Else</tt> clause.</li><li value="2">Otherwise, APL issues an error <tt>(1008) DEADLOCK</tt>.</li></ol><p>You can avoid deadlock by ensuring that threads always attempt to acquire tokens in the same chronological order, and that threads never attempt to acquire tokens that they already own.</p><p>Note that token acquisition for any particular <tt>:Hold</tt> is atomic, that is, either <span class="Italic">all </span>of the tokens or <span class="Italic">none </span>of them are acquired. The following example <span class="Italic">cannot</span> deadlock:</p><table><tr><th class="Left">Thread 1</th><th class="Left">Thread 2</th></tr><tr><td><pre>:Hold 'red'
    ...
    :Hold 'green'
        ...
    :EndHold
:EndHold
</pre></td><td><pre>
:Hold 'green' 'red'
    ...
    :EndHold

</pre></td></tr></table><h4>Examples</h4><p><tt>:Hold</tt> could be used for example, during the update of a complex data structure that might take several lines of code. In this case, an appropriate value for the token would be the name of the data structure variable itself, although this is just a programming convention: the interpreter does not associate the token value with the data variable.</p><pre>    :Hold'Struct'
        ...              ⍝ Update Struct
        Struct ← ...
    :EndHold</pre><p>The next example guarantees exclusive use of the current namespace:</p><pre>    :Hold ⎕CS''          ⍝ Hold current space
        ...
    :EndHold</pre><p>The following example shows code that holds two positions in a vector while the contents are exchanged.</p><pre>    :Hold ⍕¨to fm
        :If &gt;/vec[fm to]
            vec[fm to]←vec[to fm]
        :End
    :End</pre><p>Between obtaining the next available file tie number and using it:</p><pre>    :Hold '⎕FNUMS'
        tie←1+⌈/0,⎕FNUMS
        fname ⎕FSTIE tie
    :End</pre><p>The above hold is not necessary if the code is combined into a single line:</p><pre>    fname ⎕FSTIE tie←1+⌈/0,⎕FNUMS</pre><p>or,</p><pre>    tie←fname ⎕FSTIE 0</pre><p>Note that <tt>:Hold</tt>, like its component file system counterpart <tt>⎕FHOLD</tt>, is a device to enable <span class="Italic">co-operating </span>threads to synchronise their operation. </p><p><tt>:Hold</tt> does not <span class="Italic">prevent </span>threads from updating the same data structures concurrently, it prevents threads only from <tt>:Hold</tt>-ing the same tokens.</p><script src="../../../help.js"></script></body>
</html>