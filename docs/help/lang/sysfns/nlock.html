<!doctype html>
<html>
<head><meta charset="utf-8"><title></title><link rel="stylesheet" href="../../../help.css"></head>
<body><h2><tt>{R}←X ⎕NLOCK Y</tt>Native File Lock</h2><p>This function assists the controlled update of shared native files by locking a range of bytes.</p><p>Locking enables controlled update of native files by co-operating users. A process requesting a lock on a region of a file will be <span class="Italic">blocked</span> until that region becomes available. A <span class="Italic">write-lock</span> is exclusive, whereas a <span class="Italic">read-lock</span> is shared. In other words, any byte in a file may be in one of only three states:</p><ul><li value="1">Unlocked</li><li value="2">Write-locked by exactly one process.</li><li value="3">Read-locked by any number of processes.</li></ul><p><tt>Y</tt> must be a simple integer scalar or vector containing 1, 2 or 3 items namely:</p><ol><li value="1">Tie number</li><li value="2">Offset (from 0) of first byte of region. Defaults to 0</li><li value="3">Number of bytes to lock. Defaults to maximum possible file size</li></ol><p><tt>X</tt> must be a simple integer scalar or vector containing 1 or 2 items, namely:</p><ol><li value="1">Type: 0: Unlock, 1:Read lock, 2:Write lock.</li><li value="2">Timeout: Number of seconds to wait for lock before generating a  <tt>TIMEOUT</tt> error. Defaults to indefinite wait.</li></ol><p>The shy result <tt>R</tt> is <tt>Y</tt>. To unlock the file, this value should subsequently be supplied in the right argument to <tt>0 ⎕NLOCK</tt>. </p><h4>Examples:</h4><pre>    2 ⎕NLOCK ¯1        ⍝ write-lock whole file
    0 ⎕NLOCK ¯1        ⍝ unlock whole file.
    1 ⎕NLOCK ¯1        ⍝ read (share) lock whole file.
    2 ⎕NLOCK¨⎕NNUMS    ⍝ write-lock all files.
    0 ⎕NLOCK¨⎕NNUMS    ⍝ unlock all files.
 
    1 ⎕NLOCK ¯1 12 1   ⍝ read-lock byte 12.
    1 ⎕NLOCK ¯1 0 10   ⍝ read-lock first 10 bytes.
    2 ⎕NLOCK ¯1 20     ⍝ write-lock from byte 20 onwards.
    2 ⎕NLOCK ¯1 10 2   ⍝ write-lock 2 bytes from byte 10
    0 ⎕NLOCK ¯1 12 1   ⍝ remove lock from byte 12.</pre><p>To lock the region immediately beyond the end of the file prior extending it:</p><pre>   ⎕←region←2 ⎕NLOCK ¯1, ⎕NSIZE ¯1 ⍝ write-lock from EOF.
¯1 1000   
   ... ⎕NAPPEND ¯1                 ⍝ append bytes to file
   ... ⎕NAPPEND ¯1                 ⍝ append bytes to file
 
   0 ⎕NLOCK region                 ⍝ release lock.</pre><p>The left argument may have a second optional item that specifies a <span class="Italic">timeout</span> value. If a lock has not been acquired within this number of seconds, the acquisition is abandoned and a <tt>TIMEOUT</tt> error reported.</p><pre>    2 10 ⎕nlock ¯1      ⍝ wait up to 10 seconds for lock.</pre><h4>Notes:</h4><p>There is no <span class="Italic">per-byte</span> cost associated with region locking. It takes the same time to lock/unlock a region, irrespective of that region’s size.</p><p>Different file servers implement locks in slightly different ways. For example on some systems, locks are <span class="Italic">advisory</span>. This means that a write lock on a region precludes other locks intersecting that region, but doesn't stop reads or writes across the region. On the other hand, <span class="Italic">mandatory</span> locks block both other locks <span class="Italic">and</span> read/write operations. <tt>⎕NLOCK</tt> will just pass the server's functionality along to the APL programmer without trying to standardise it across different systems.</p><p>All locks on a file will be removed by <tt>⎕NUNTIE</tt>.</p><p>Blocked locking requests can be freed by a strong interrupt. Under Windows, this operation is performed from the Dyalog APL pop-up menu in the system tray.</p><h4>Errors</h4><p>In this release, an attempt to unlock a region that contains bytes that have not been locked results in a <tt>DOMAIN ERROR</tt>.</p><p>A <tt>LIMIT ERROR</tt> results if the operating system lock daemon has insufficient resources to honour the locking request.</p><p>Some systems support only write locks. In this case an attempt to set a read lock will generate a <tt>DOMAIN ERROR</tt>, and it may be appropriate for the APL programmer to trap the error and apply a write lock.</p><p>No attempt will be made to detect deadlock. Some servers do this and if such a condition is detected, a <tt>DEADLOCK</tt> error (1008) will be reported.</p></body>
</html>